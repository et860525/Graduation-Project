{% extends 'base.html' %}

{% block title %}Search Stock{% endblock %}

{% block content %}
<style>
    table,
    td {
        border: 1px solid #333;
    }

    thead,
    tfoot {
        background-color: #333;
        color: #fff;
    }

    .chart-btn button span {
        font: bold;
    }

    .chart-btn button:hover {
        color: #0f69ff;
    }
</style>

<body>
    <div class="container">
        <h1>{{info_result.shortName}} ({{stockname}})</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button"
                    role="tab" aria-controls="home" aria-selected="true">Home</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button"
                    role="tab" aria-controls="profile" aria-selected="false">Profile</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button"
                    role="tab" aria-controls="contact" aria-selected="false">Contact</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="m-3">
                    <div class="stock-price-widget d-flex">
                        <div class="chart-btn ms-3">
                            <button type="button" onclick="chartBtn('1M')" class="btn"><span>1M</span></button>
                            <button type="button" onclick="chartBtn('6M')" class="btn"><span>6M</span></button>
                            <button type="button" onclick="chartBtn('1Y')" class="btn"><span>1Y</span></button>
                            <button type="button" onclick="chartBtn('3Y')" class="btn"><span>3Y</span></button>
                            <button type="button" onclick="chartBtn('5Y')" class="btn"><span>5Y</span></button>
                        </div>
                    </div>
                    <!--Data-->
                    {{ stock_price|json_script:'stock_price' }}
                    {{ stock_date|json_script:'stock_date' }}
                    <canvas id="myChart" width="100" height="50"></canvas>
                </div>
                <!--TODO Choice what infomation put under the chart-->
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>{{stockname}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key,value in info_result.items %}
                        <tr>
                            <td>{{key}}</td>
                            <td>{{value}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>{{stockname}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key,value in info_result.items %}
                        <tr>
                            <td>{{key}}</td>
                            <td>{{value}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">...</div>
        </div>


    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        /* Original Data */
        var js_stock_date = JSON.parse(document.getElementById('stock_date').textContent);
        var js_stock_price = JSON.parse(document.getElementById('stock_price').textContent);

        /* Show Data */
        var stock_price = [];
        var stock_date = [];

        /* Make date unique */
        const uniquet = (value, index, self) => {
            return self.indexOf(value) === index
        }

        /* Slice all Y-M-D to Y-M */
        let stock_date_all_Month = [];
        for (let i = 0; i < js_stock_date.length; i++) {
            stock_date_all_Month.push(js_stock_date[i].slice(0, 7))
        }

        /* Make Month unique */
        var stock_date_5y = stock_date_all_Month.filter(uniquet)

        /* Use slice Date to find index of stock_price_close */
        let date_index = [];
        for (let i = 0; i < stock_date_5y.length; i++) {
            date_index.push(stock_date_all_Month.lastIndexOf(stock_date_5y[i]))
        }

        let n = 0;
        var stock_price_5y = [];
        while (n < date_index.length) {
            stock_price_5y.push(js_stock_price[date_index[n]])
            n++;
        }

        /* Shallow copy make sure original data not change */
        stock_date = stock_date_5y.slice();
        stock_price = stock_price_5y.slice();

        // <block:setup:1>
        var ctx = document.getElementById("myChart");
        var myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: stock_date, // 換成自己的labels
                datasets: [{
                    label: 'stock price',
                    data: stock_price, // 換成自己的data
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
            }
        });

        /* Get chart button and return some value with setting (5y,3y,1y,6m,1m) */
        var isDate = '5Y'; // Check btn press
        function chartBtn(d) {
            switch (d) {
                case '5Y':
                    if (isDate != d) {
                        chartSelectDate(myChart, 0, d);
                    }
                    break;
                case '3Y':
                    if (isDate != d) {
                        chartSelectDate(myChart, -38, d);
                    }
                    break;
                case '1Y':
                    if (isDate != d) {
                        chartSelectDate(myChart, -13, d);
                    }
                    break;
                case '6M':
                    if (isDate != d) {
                        chartSelectDate(myChart, -6, d);
                    }
                    break;
                case '1M':
                    chartData1M(myChart, d);
                    break;
            }

        }

        /* 
            Get data when client press btn
                chartSelectDate(chart, val, _isDate)
                    chart: What chart select
                    val: Send how many Month
                    _isDate: check btn is presss or not
        */
        function chartSelectDate(chart, val, _isDate) {
            /* Reset date and price in first */
            stock_date = [];
            stock_price = [];

            /* Use shallow copy(slice function) to make original data is const. */
            stock_date = stock_date_5y.slice(val);
            stock_price = stock_price_5y.slice(val);

            /* Set up data on chart. */
            chart.data.labels = stock_date;
            chart.data.datasets[0].data = stock_price;

            isDate = _isDate;
            chart.update('active');
        }

        function chartData1M(chart, _isDate) {
            /* Reset date and price in first */
            stock_date = [];
            stock_price = [];

            let stock_date_1m = [];
            let stock_price_1m = [];

            for (let i = js_stock_date.length - 1; i > (js_stock_date.length - 32); i--) {
                stock_date_1m.push(js_stock_date[i])
                stock_price_1m.push(js_stock_price[i])
            }

            stock_date = stock_date_1m.slice();
            stock_price = stock_price_1m.slice();

            chart.data.labels = stock_date.reverse();
            chart.data.datasets[0].data = stock_price.reverse();

            isDate = _isDate;
            chart.update('active');
        }

    </script>

    <script>
        // === include 'setup' then 'config' above ===
        var ctx = document.getElementById('myChart');
    </script>
</body>

{% endblock %}